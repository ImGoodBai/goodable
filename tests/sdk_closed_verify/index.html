<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SDK Stdio Test - Electron</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
      margin: 0;
    }
    h1 {
      color: #4ec9b0;
      margin-bottom: 10px;
    }
    .info {
      background: #2d2d30;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    .info-line {
      margin: 5px 0;
    }
    .info-label {
      color: #9cdcfe;
      display: inline-block;
      width: 150px;
    }
    .test-section {
      background: #252526;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    h2 {
      color: #569cd6;
      margin-top: 0;
      font-size: 18px;
    }
    .test-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    button:hover {
      background: #1177bb;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    button.danger {
      background: #c5000b;
    }
    button.danger:hover {
      background: #e81123;
    }
    button.success {
      background: #107c10;
    }
    button.success:hover {
      background: #13a10e;
    }
    .test-description {
      color: #858585;
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.5;
    }
    .test-item {
      background: #2d2d30;
      padding: 15px;
      border-radius: 4px;
      border-left: 3px solid #0e639c;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      background: #2d2d30;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .result.success {
      background: #13331a;
      border: 1px solid #107c10;
      color: #4ec9b0;
    }
    .result.error {
      background: #331313;
      border: 1px solid #c5000b;
      color: #f48771;
    }
    .result.running {
      background: #1a2a3a;
      border: 1px solid #0e639c;
      color: #9cdcfe;
    }
  </style>
</head>
<body>
  <h1>ğŸ” Claude Agent SDK - Stdio é€šé“æµ‹è¯•</h1>

  <div class="info">
    <div class="info-line">
      <span class="info-label">ç¯å¢ƒä¿¡æ¯ï¼š</span>
      <span id="appInfo">åŠ è½½ä¸­...</span>
    </div>
    <div class="info-line">
      <span class="info-label">æ—¥å¿—æ–‡ä»¶ï¼š</span>
      <span id="logPath">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ“‹ æµ‹è¯•æ–¹æ¡ˆ</h2>
    <p style="color: #858585; margin-top: 0;">
      åœ¨Electronæ‰“åŒ…ç¯å¢ƒä¸‹æµ‹è¯•ä¸åŒçš„spawné…ç½®å¯¹SDK stdioé€šé“çš„å½±å“
    </p>

    <div class="test-grid">
      <div class="test-item">
        <button onclick="runTest(1)" id="btn1">æµ‹è¯•1: é»˜è®¤Spawn</button>
        <div class="test-description">
          ä½¿ç”¨SDKé»˜è®¤spawné…ç½®<br>
          é¢„æœŸï¼šåœ¨æ‰“åŒ…ç¯å¢ƒå¯èƒ½å¤±è´¥
        </div>
      </div>

      <div class="test-item">
        <button onclick="runTest(2)" id="btn2" class="success">æµ‹è¯•2: è‡ªå®šä¹‰Spawn â­</button>
        <div class="test-description">
          ä½¿ç”¨è‡ªå®šä¹‰spawnï¼Œæ˜ç¡®stdioé…ç½®<br>
          é¢„æœŸï¼šä¿®å¤stdioé€šé“é—®é¢˜
        </div>
      </div>

      <div class="test-item">
        <button onclick="runTest(3)" id="btn3">æµ‹è¯•3: é»˜è®¤Spawn + Hook</button>
        <div class="test-description">
          é»˜è®¤spawné…ç½® + PreToolUse Hook<br>
          é¢„æœŸï¼šHookå›è°ƒå¯èƒ½å¤±è´¥
        </div>
      </div>

      <div class="test-item">
        <button onclick="runTest(4)" id="btn4" class="success">æµ‹è¯•4: è‡ªå®šä¹‰Spawn + Hook â­</button>
        <div class="test-description">
          è‡ªå®šä¹‰spawn + PreToolUse Hook<br>
          é¢„æœŸï¼šå®Œæ•´åŠŸèƒ½æ­£å¸¸
        </div>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <button onclick="runAllTests()" style="width: 100%;" class="success">
        ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
      </button>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
    <div id="status" class="status">
      ç­‰å¾…æµ‹è¯•å¼€å§‹...
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let isRunning = false;

    // åŠ è½½åº”ç”¨ä¿¡æ¯
    async function loadAppInfo() {
      const info = await ipcRenderer.invoke('get-app-info');
      const logPath = await ipcRenderer.invoke('get-log-path');

      document.getElementById('appInfo').innerHTML = `
        ${info.isPackaged ? '<span style="color:#4ec9b0">âœ… å·²æ‰“åŒ…</span>' : '<span style="color:#ce9178">âš ï¸ å¼€å‘æ¨¡å¼</span>'} |
        NODE_ENV: ${info.nodeEnv || 'undefined'} |
        Platform: ${info.platform}
      `;
      document.getElementById('logPath').textContent = logPath;
    }

    loadAppInfo();

    // ã€æ–°å¢ã€‘è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•ï¼ˆå»¶è¿Ÿ1ç§’ç¡®ä¿ç•Œé¢åŠ è½½å®Œæˆï¼‰
    setTimeout(() => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('auto') === 'true' || window.location.hash === '#auto') {
        log('<div class="result running">âš¡ è‡ªåŠ¨æµ‹è¯•æ¨¡å¼ - 3ç§’åå¼€å§‹æ‰§è¡Œå…¨éƒ¨æµ‹è¯•...</div>');
        setTimeout(runAllTests, 3000);
      }
    }, 1000);

    function log(message) {
      const status = document.getElementById('status');
      const timestamp = new Date().toLocaleTimeString();
      status.innerHTML += `[${timestamp}] ${message}\n`;
      status.scrollTop = status.scrollHeight;
    }

    function clearLog() {
      document.getElementById('status').innerHTML = '';
    }

    function setButtonsEnabled(enabled) {
      isRunning = !enabled;
      for (let i = 1; i <= 4; i++) {
        document.getElementById(`btn${i}`).disabled = !enabled;
      }
    }

    async function runTest(testNumber) {
      if (isRunning) {
        alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
        return;
      }

      setButtonsEnabled(false);
      clearLog();

      const configs = {
        1: { name: 'æµ‹è¯•1: é»˜è®¤Spawn', useCustomSpawn: false, useHook: false },
        2: { name: 'æµ‹è¯•2: è‡ªå®šä¹‰Spawn', useCustomSpawn: true, useHook: false },
        3: { name: 'æµ‹è¯•3: é»˜è®¤Spawn + Hook', useCustomSpawn: false, useHook: true },
        4: { name: 'æµ‹è¯•4: è‡ªå®šä¹‰Spawn + Hook', useCustomSpawn: true, useHook: true },
      };

      const config = configs[testNumber];

      log(`<div class="result running">ğŸš€ å¼€å§‹${config.name}</div>`);
      log('');

      try {
        const result = await ipcRenderer.invoke('run-test', config);

        log('');
        log('========================================');
        log('ğŸ“Š æµ‹è¯•ç»“æœ');
        log('========================================');
        log(`æ€»æ¶ˆæ¯æ•°: ${result.messageCount || 0}`);
        if (result.hookCallCount !== undefined) {
          log(`Hookè°ƒç”¨æ¬¡æ•°: ${result.hookCallCount}`);
        }
        if (result.duration) {
          log(`è€—æ—¶: ${(result.duration / 1000).toFixed(2)}s`);
        }

        if (result.success) {
          log(`<div class="result success">âœ… æµ‹è¯•é€šè¿‡</div>`);
        } else {
          log(`<div class="result error">âŒ æµ‹è¯•å¤±è´¥</div>`);
          if (result.error) {
            log(`é”™è¯¯: ${result.error}`);
          }
        }

      } catch (error) {
        log(`<div class="result error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`);
      } finally {
        setButtonsEnabled(true);
      }
    }

    async function runAllTests() {
      if (isRunning) {
        alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
        return;
      }

      clearLog();
      log('<div class="result running">ğŸš€ å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯•ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰</div>');
      log('');

      for (let i = 1; i <= 4; i++) {
        await runTest(i);
        if (i < 4) {
          log('');
          log('---ç­‰å¾…2ç§’åç»§ç»­ä¸‹ä¸€ä¸ªæµ‹è¯•---');
          log('');
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }

      log('');
      log('<div class="result success">âœ… å…¨éƒ¨æµ‹è¯•å®Œæˆ</div>');
    }
  </script>
</body>
</html>
