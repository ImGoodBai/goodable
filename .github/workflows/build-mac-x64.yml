name: Build macOS x64

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: 'true'
        type: boolean

  # Tag æŽ¨é€è§¦å‘ (v1.0.0, v2.1.3 ç­‰)
  push:
    tags:
      - 'v*'

  # Pull Request è§¦å‘ (ä»…æµ‹è¯•æž„å»ºï¼Œä¸ä¸Šä¼ )
  pull_request:
    branches:
      - main

# å–æ¶ˆåŒä¸€åˆ†æ”¯/æ ‡ç­¾çš„é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# æƒé™é…ç½®ï¼ˆåˆ›å»º Release å¿…é¡»ï¼‰
permissions:
  contents: write

jobs:
  build:
    name: Build for macOS x64
    runs-on: macos-15-intel  # Intel x64 æ ‡å‡† runnerï¼ˆæ”¯æŒåˆ° 2027-08ï¼‰

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä¾¿äºŽç‰ˆæœ¬æ ‡è®°

      # 2. è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. é…ç½®çŽ¯å¢ƒå˜é‡
      - name: Setup environment variables
        run: |
          # åˆ›å»º .env æ–‡ä»¶ï¼ˆç”Ÿäº§æž„å»ºæ‰€éœ€çš„æœ€å°é…ç½®ï¼‰
          cat > .env << 'EOF'
          NODE_ENV=production
          PROJECTS_DIR=./data/projects
          PORT=3000
          WEB_PORT=3000
          PREVIEW_PORT_START=3100
          PREVIEW_PORT_END=3999
          DATABASE_URL="file:./data/prod.db"
          EOF

          # å¦‚æžœéœ€è¦ API Keyï¼ˆä»Ž GitHub Secrets è¯»å–ï¼‰
          # echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> .env

      # 5. ç±»åž‹æ£€æŸ¥
      - name: TypeScript type check
        run: npm run type-check

      # 6. å¯¼å…¥ç­¾åè¯ä¹¦
      - name: Import signing certificate
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # åˆ›å»ºä¸´æ—¶ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥è¯ä¹¦
          echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          rm -f $RUNNER_TEMP/certificate.p12
          echo "Certificate imported successfully"

      # 7. æ‰§è¡Œ macOS æ‰“åŒ…è„šæœ¬ (x64)
      - name: Build macOS x64 package
        run: |
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x ./tools/build-mac2.sh
          # ä½¿ç”¨æ‰“åŒ…è„šæœ¬ï¼Œè·³è¿‡ç±»åž‹æ£€æŸ¥ï¼ˆå·²åœ¨å‰é¢æ‰§è¡Œï¼‰
          ./tools/build-mac2.sh --arch x64 --skip-type-check
        env:
          # ç­¾åé…ç½®ï¼ˆé€šè¿‡ Secrets é…ç½®ï¼‰
          CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          # å…¬è¯é…ç½®
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # 8. æ£€æŸ¥æž„å»ºäº§ç‰©
      - name: List build artifacts
        run: |
          echo "=== Build artifacts ==="
          ls -lh dist/
          echo ""
          echo "=== DMG files ==="
          find dist -name "*.dmg" -exec ls -lh {} \;
          echo ""
          echo "=== ZIP files ==="
          find dist -name "*.zip" -exec ls -lh {} \;

      # 9. ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        # ä»…åœ¨ä»¥ä¸‹æƒ…å†µä¸Šä¼ ï¼š
        # - æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†ä¸Šä¼ 
        # - Tag æŽ¨é€
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_artifacts == 'true') ||
          startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: goodable-macos-x64-${{ github.ref_name }}
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.blockmap
          retention-days: 3
          compression-level: 0  # DMG/ZIP å·²åŽ‹ç¼©ï¼Œæ— éœ€äºŒæ¬¡åŽ‹ç¼©

      # 10. å‘å¸ƒåˆ° GitHub Release (ä»… Tag æŽ¨é€)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. æ‰“å°æž„å»ºæ€»ç»“
      - name: Build summary
        if: always()
        run: |
          {
            echo "### ðŸŽ‰ Build Summary"
            echo ""
            echo "- **Platform**: macOS x64 (Intel)"
            echo "- **Node Version**: $(node -v)"
            echo "- **Trigger**: ${{ github.event_name }}"
            echo "- **Ref**: ${{ github.ref }}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -d "dist" ]; then
            {
              echo "#### ðŸ“¦ Build Artifacts"
              echo '```'
              find dist -type f \( -name "*.dmg" -o -name "*.zip" \) -exec ls -lh {} \;
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          fi
